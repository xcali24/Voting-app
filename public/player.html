<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Player</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="player-card">
    <div id="identity"></div>
    <h1>Wähle einen Spieler</h1>
    <div id="buttons" class="player-buttons"></div>
  </div>

  <script>
    const ws = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host
    );

    let myName = localStorage.getItem("playerName");
    let players = {};

    ws.onopen = () => {
      if (!myName) {
        askIdentity();
      } else {
        ws.send(JSON.stringify({ type: "identify", name: myName }));
      }
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "state") {
        players = data.players;
        render();
      }
    };

    function askIdentity() {
      const name = prompt("Wer bist du?");
      if (!name) return;

      myName = name.replace("/", "").trim();
      localStorage.setItem("playerName", myName);
      ws.send(JSON.stringify({ type: "identify", name: myName }));
    }

    function render() {
      document.getElementById("identity").textContent =
        "Du bist: //" + myName;

      const container = document.getElementById("buttons");
      container.innerHTML = "";

      const myData = players[myName];
      const myVote = myData ? myData.votedFor : null;

      Object.keys(players).forEach((name) => {
        if (name === myName) return;

        const btn = document.createElement("button");
        btn.className = "player-btn";
        btn.textContent =
          myVote === name
            ? "Dein Vote: //" + name
            : "Vote für //" + name;

        btn.onclick = () => {
          ws.send(
            JSON.stringify({
              type: "vote",
              voter: myName,
              target: name,
            })
          );
        };

        container.appendChild(btn);
      });
    }
  </script>
</body>
</html>
