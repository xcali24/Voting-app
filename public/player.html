<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Voting – Spieler</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <div id="top" class="topbar"></div>
        <h1 id="title">Lade...</h1>
        <div id="playerArea"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let myName = localStorage.getItem("myName");
        let myVote = null;
        let myHearts = 3;
        let currentPlayers = [];

        // WICHTIG: Wenn wir schon einen Namen haben → sofort beim Server anmelden
        socket.on("connect", () => {
            if (myName) {
                socket.emit("identify", myName);
            }
        });

        socket.on("playersUpdate", (list) => {
            currentPlayers = list;
            render();
        });

        socket.on("voteUpdate", (data) => {
            if (data.yourVote !== undefined) {
                myVote = data.yourVote;
            }
            render();
        });

        socket.on("detailedResults", (data) => {
            if (myName && data[myName]) {
                myHearts = data[myName].hearts ?? 3;
            }
            render();
        });

        function renderHearts(count) {
            let text = "";
            for (let i = 0; i < 3; i++) {
                text += i < count ? "♥︎ " : "♡ ";
            }
            return text;
        }

        function render() {
            const area = document.getElementById("playerArea");
            const title = document.getElementById("title");
            const top = document.getElementById("top");

            area.innerHTML = "";
            top.innerHTML = "";

            // IDENTITÄTSWAHL
            if (!myName) {
                title.textContent = "Wer bist du?";

                const grid = document.createElement("div");
                grid.className = "playerGrid";

                currentPlayers.forEach((player) => {
                    const card = document.createElement("div");
                    card.className = "playerCard";
                    card.textContent = "/" + player;

                    card.onclick = () => {
                        myName = player;
                        localStorage.setItem("myName", player);
                        socket.emit("identify", player);
                        render();
                    };

                    grid.appendChild(card);
                });

                area.appendChild(grid);
                return;
            }

            // TOP BAR
            title.textContent = "Wähle einen Spieler";

            const nameBox = document.createElement("div");
            nameBox.textContent = "Du bist: /" + myName;

            const hearts = document.createElement("div");
            hearts.className = "heartDisplay";
            hearts.textContent = renderHearts(myHearts);

            top.appendChild(nameBox);
            top.appendChild(hearts);

            // VOTING GRID
            const grid = document.createElement("div");
            grid.className = "playerGrid";

            currentPlayers.forEach((player) => {
                const card = document.createElement("div");
                card.className = "playerCard";

                if (myVote === player) {
                    card.classList.add("voted");
                    card.textContent = "Dein Vote:\n/" + player;
                } else {
                    card.textContent = "/" + player;

                    if (!myVote) {
                        card.onclick = () => {
                            socket.emit("vote", player);
                        };
                    } else {
                        card.classList.add("disabled");
                    }
                }

                grid.appendChild(card);
            });

            area.appendChild(grid);
        }
    </script>
</body>
</html>
