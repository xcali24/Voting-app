<!DOCTYPE html>
<html lang="de">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <title>Admin Panel</title>
</head>
<body>
    <h1>Admin Panel</h1>

    <div class="layout">
        <!-- LINKE SEITE -->
        <div class="leftPanel">

            <div class="card">
                <h2>Spieler hinzufÃ¼gen</h2>
                <input type="text" id="playerName" placeholder="Spielername eingeben">
                <button onclick="addPlayer()">HinzufÃ¼gen</button>
            </div>

            <div class="card">
                <h2>Spielerliste</h2>
                <ul id="playerList"></ul>
            </div>

            <div class="card">
                <h2>Voting-Steuerung</h2>
                <button id="startVoting" class="admin-btn">Voting starten</button>
                <button id="stopVoting" class="admin-btn">Voting beenden</button>
                <button id="revealAll" class="admin-btn">Alle Votes aufdecken</button>
                <button id="revealNext" class="admin-btn">NÃ¤chsten Vote aufdecken</button>
                <button id="hideVotes" class="admin-btn">Votes verbergen</button>
            </div>

            <!-- Overlay-URLs Box (verschoben nach unten) -->
            <div class="card">
                <h2>Overlay-URLs fÃ¼r OBS</h2>
                <button onclick="copyAllURLs()" style="margin-bottom: 15px; width: 100%;">ðŸ“‹ Alle URLs kopieren</button>
                <div id="urlList"></div>
            </div>

        </div>

        <!-- RECHTE SEITE -->
        <div class="rightPanel">

            <div class="card">
                <h2>Fragen</h2>
                <div id="questions" class="questionBox">
                    Lade Fragen...
                </div>
            </div>

            <div class="card">
                <h2>Voting-Ergebnis</h2>
                <div id="resultBox"></div>
            </div>

        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let playersCache = [];
        let detailedResults = {};

        // ==================== FUNKTIONEN ====================

        function addPlayer() {
            const input = document.getElementById("playerName");
            const name = input.value.trim();

            if (name === "") return;

            socket.emit("addPlayer", name);
            input.value = "";
        }

        function renderPlayers(players) {
            const list = document.getElementById("playerList");
            list.innerHTML = "";

            players.forEach((player) => {
                const li = document.createElement("li");

                const hasVoted =
                    detailedResults[player] &&
                    detailedResults[player].votedFor;

                const status = hasVoted ? "âœ“" : "âœ–";

                li.textContent = player + " â€” " + status + " ";

                // Entfernen-Button
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "Entfernen";
                removeBtn.onclick = () => {
                    socket.emit("removePlayer", player);
                };

                // Herz minus
                const minusBtn = document.createElement("button");
                minusBtn.textContent = "- Herz";
                minusBtn.onclick = () => {
                    socket.emit("changeHearts", { player, amount: -1 });
                };

                // Herz plus
                const plusBtn = document.createElement("button");
                plusBtn.textContent = "+ Herz";
                plusBtn.onclick = () => {
                    socket.emit("changeHearts", { player, amount: 1 });
                };

                li.appendChild(removeBtn);
                li.appendChild(minusBtn);
                li.appendChild(plusBtn);

                list.appendChild(li);
            });
        }

        function renderResults() {
            const box = document.getElementById("resultBox");
            box.innerHTML = "";

            playersCache.forEach((player) => {
                const data = detailedResults[player];
                if (!data) return;

                const row = document.createElement("div");
                row.style.display = "flex";
                row.style.justifyContent = "space-between";
                row.style.padding = "6px 0";
                row.style.borderBottom = "1px solid rgba(255,255,255,0.1)";

                row.innerHTML = `
                    <span>/${player}</span>
                    <span>â†’ /${data.votedFor || "-"}</span>
                    <span>| ${data.votes || 0} Votes</span>
                `;

                box.appendChild(row);
            });
        }

        // ==================== URL-LISTE RENDERN ====================

        function renderURLList() {
            const baseURL = window.location.origin; // z.B. https://meine-app.onrender.com
            const urlBox = document.getElementById("urlList");
            urlBox.innerHTML = "";

            if (playersCache.length === 0) {
                urlBox.innerHTML = "<p style='color: #888; font-size: 14px;'>Keine Spieler hinzugefÃ¼gt</p>";
                return;
            }

            playersCache.forEach((player) => {
                const url = `${baseURL}/overlay.html?player=${player}`;

                const row = document.createElement("div");
                row.style.marginBottom = "10px";
                row.style.padding = "10px";
                row.style.background = "#111";
                row.style.borderRadius = "8px";

                const playerName = document.createElement("div");
                playerName.textContent = `/${player}`;
                playerName.style.fontWeight = "bold";
                playerName.style.marginBottom = "5px";

                const urlText = document.createElement("input");
                urlText.value = url;
                urlText.readOnly = true;
                urlText.style.width = "100%";
                urlText.style.padding = "6px";
                urlText.style.fontSize = "12px";
                urlText.style.background = "#0a0a0a";
                urlText.style.border = "1px solid #333";
                urlText.style.borderRadius = "4px";
                urlText.style.color = "#aaa";
                urlText.style.marginBottom = "5px";

                const copyBtn = document.createElement("button");
                copyBtn.textContent = "ðŸ“‹ Kopieren";
                copyBtn.style.width = "100%";
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(url).then(() => {
                        copyBtn.textContent = "âœ… Kopiert!";
                        setTimeout(() => {
                            copyBtn.textContent = "ðŸ“‹ Kopieren";
                        }, 2000);
                    });
                };

                row.appendChild(playerName);
                row.appendChild(urlText);
                row.appendChild(copyBtn);

                urlBox.appendChild(row);
            });
        }

        function copyAllURLs() {
            const baseURL = window.location.origin;
            let allURLs = "";

            playersCache.forEach((player) => {
                allURLs += `${player}: ${baseURL}/overlay.html?player=${player}\n`;
            });

            if (allURLs === "") {
                alert("Keine Spieler hinzugefÃ¼gt!");
                return;
            }

            navigator.clipboard.writeText(allURLs).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = "âœ… Alle kopiert!";
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function renderResults() {
            const box = document.getElementById("resultBox");
            box.innerHTML = "";

            playersCache.forEach((player) => {
                const data = detailedResults[player];
                if (!data) return;

                const row = document.createElement("div");
                row.style.display = "flex";
                row.style.justifyContent = "space-between";
                row.style.padding = "6px 0";
                row.style.borderBottom = "1px solid rgba(255,255,255,0.1)";

                row.innerHTML = `
                    <span>/${player}</span>
                    <span>â†’ /${data.votedFor || "-"}</span>
                    <span>| ${data.votes || 0} Votes</span>
                `;

                box.appendChild(row);
            });
        }

        function setActive(button) {
            document.querySelectorAll(".admin-btn").forEach(b => {
                b.classList.remove("active");
            });
            button.classList.add("active");
        }

        // ==================== BUTTON EVENTS ====================

        const startBtn = document.getElementById("startVoting");
        const stopBtn = document.getElementById("stopVoting");
        const revealAllBtn = document.getElementById("revealAll");
        const revealNextBtn = document.getElementById("revealNext");
        const hideBtn = document.getElementById("hideVotes");

        startBtn.onclick = () => {
            socket.emit("startVoting");
            setActive(startBtn);
        };

        stopBtn.onclick = () => {
            socket.emit("stopVoting");
            setActive(stopBtn);
        };

        revealAllBtn.onclick = () => {
            socket.emit("revealVotes");
            setActive(revealAllBtn);
        };

        revealNextBtn.onclick = () => {
            socket.emit("revealNextVote");
            setActive(revealNextBtn);
        };

        hideBtn.onclick = () => {
            socket.emit("hideVotes");
            setActive(hideBtn);
        };

        // ==================== SOCKET EVENTS ====================

        socket.on("playerList", (players) => {
            playersCache = players;
            renderPlayers(players);
            renderURLList(); // NEU: URL-Liste aktualisieren
        });

        socket.on("detailedResults", (data) => {
            detailedResults = data;
            renderPlayers(playersCache);
            renderResults();
        });

        // Fragen laden
        fetch("fragen.txt")
            .then(res => res.text())
            .then(text => {
                document.getElementById("questions").textContent = text;
            })
            .catch(() => {
                document.getElementById("questions").textContent = "Keine Fragen-Datei gefunden.";
            });
    </script>
</body>
</html>
